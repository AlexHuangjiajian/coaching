<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../../static/layui/css/layui.css" media="all">
    <script type="application/javascript" src="../../static/js/jquery-1.7.2.js"></script>
    <script src="../../static/layui/layui.js"></script>
    <style>
       .layui-input-block{
           width: 250px;
       }
        .layui-form{
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="layui-container">
<form class="layui-form" action="">

    <div class="layui-form-item">
        <label class="layui-form-label">材料选择:</label>
        <div class="layui-input-block">
            <select name="mNameList" lay-verify="required"  lay-filter="mNameList" lay-search >
                <option value="-1"></option>
            </select>
        </div>
    </div>

    <div class="layui-form-item lot-num-select">
    <label class="layui-form-label">批号:</label>
        <!--<input type="text" name="title" placeholder="请输入批号" autocomplete="off" class="layui-input">-->
        <div class="layui-input-block">
        <select name="lotNumberList" lay-verify="required" lay-search>
            <option value="-1"></option>
        </select>
            <div>
                <span id="addLotNumber"><i class="layui-icon layui-icon-add-1" style="font-size: 30px;"></i></span>
            </div>
        </div>
</div>

    <div class="layui-form-item">
        <label class="layui-form-label">出仓数量:</label>
        <div class="layui-input-block">
            <input type="text" name="num" required  lay-verify="required" placeholder="请输入数量"  class="layui-input">
            <label class="layui-form-label">规格:</label>
            <input type="text" name="specifications" value="kg"  class="layui-input" disabled="disabled">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">实际出仓量:</label>
        <div class="layui-input-block">
            <input type="text" name="outNum"  id="outNum" class="layui-input" disabled="disabled">
        </div>
    </div>


    <div class="layui-form-item">
        <label class="layui-form-label">复选框</label>
        <div class="layui-input-block">
            <input type="checkbox" name="like[write]" title="写作">
            <input type="checkbox" name="like[read]" title="阅读" checked>
            <input type="checkbox" name="like[dai]" title="发呆">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">开关</label>
        <div class="layui-input-block">
            <input type="checkbox" name="switch" lay-skin="switch">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">单选框</label>
        <div class="layui-input-block">
            <input type="radio" name="sex" value="男" title="男">
            <input type="radio" name="sex" value="女" title="女" checked>
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">文本域</label>
        <div class="layui-input-block">
            <textarea name="desc" placeholder="请输入内容" class="layui-textarea"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
</div>
<script>
    //渲染材料下拉框
    var getNameList = function(){
        layui.use('form',function(){
            var form  = layui.form;
        $.ajax({
            type: "get",
            url: "/material/getNameList",
            async: false, // 同步
            contentType: 'application/x-www-form-urlencoded;charset=utf-8',
            success: function(data){
                 if(data.code==0){
                     for(var i=0;i<data.list.length;i++){
                         var str =  '<option value="'+data.list[i].id+'">'+data.list[i].name+'</option>';
                         $("select[name='mNameList']").append(str);
                     }
                     $("select[name='mNameList'] layui-select-title").val("");
                 }
                form.render("select");
            },
            error:function(e){
                console.log(e);
            }
        });
        });
    };

    //渲染批号下拉框
    var getLotNumberList = function(selectMaterialId){
        layui.use('form',function(){
            var form  = layui.form;
        var selectMaterial = $("select[name='mNameList'] option:selected").text();
        console.log("材料名："+selectMaterial);
        console.log("材料ID:"+selectMaterialId);
        if(selectMaterial!=undefined && selectMaterial!=null && selectMaterial!='' && selectMaterialId!=-1){
            $("select[name='lotNumberList']").empty();
            $.ajax({
                type: "get",
                url: "/materialIn/getLnList",
                async: false, // 同步
                data:{"materialId":selectMaterialId},
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                success: function(data){
                    if(data.code==0){
                        for(var i=0;i<data.list.length;i++){
                            var str =  '<option value="'+i+'"> 批号:'+data.list[i].lotNumber+'  库存:'+data.list[i].stock+'/'
                                +data.list[i].specifications+'</option>';
                            console.log(str);
                            $("select[name='lotNumberList']").append(str);
                        }
                    }
                    form.render("select");
                },
                error:function(e){
                    console.log(e);
                }
            });
        }else{
            alertMsg("请先选择材料!");
        }
        });
    };

    //添加多一个批号选择
    var addLotNumber = function () {
        alert(1);
        $("#addLotNumber").click(function(){
            var html =  $(".lot-num-select:last").clone();
            //获取已选择批号,下一个下拉框不选择
            var selectdLn = $(".lot-num-select:last lotNumberList option:selected").val();
            alert(selectdLn);
            $(".lot-num-select:last").after(html);
            //删除已选择的批号
            $(".lot-num-select:last lotNumberList option[value='"+selectdLn+"']").remove();
        })
    }

    //计算实际出仓量( 还待编写)
    /*var caluOutNum = function(){
        $("#num").onchange(function () {
            //获取输入数量
            var num = $("#num").val();
            //获取选择批号材料库存
            var stock = $("#").val();
            if(num>stock){
               layui.msg("库存不足");
            }else{
            }
        })
        $("#outNum").val();
    }*/

    $(function () {
        //渲染材料框
        getNameList();
        //监听加号
        addLotNumber();
    });

    var alertMsg = function(msg){
        layui.use(['layer'], function(){
            var layer = layui.layer;
            layer.msg(msg);
        })
    }

    layui.use('form', function(){
        var form = layui.form;

        form.on('select(mNameList)', function(data){
            console.log(data.elem); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象
            //渲染批号框
            getLotNumberList(data.value);
        });

        //监听提交
        form.on('submit(formDemo)', function(data){
            layer.msg(JSON.stringify(data.field));
            return false;
        });
    });
</script>
</body>
</html>